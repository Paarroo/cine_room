<section class="filters-section py-6">
  <div class="container-app">
    <div class="glass-effect rounded-3xl p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-white">
          <i class="fas fa-filter text-primary mr-2"></i>
          Filtres et Recherche
        </h3>

        <!-- Clear Filters Button -->
        <%= link_to admin_participations_path,
            class: "px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm transition-colors" do %>
          <i class="fas fa-times mr-2"></i>Effacer les filtres
        <% end %>
      </div>

      <!-- Search and Filter Form -->
      <%= form_with url: admin_participations_path, method: :get,
          class: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",
          data: { turbo_frame: "_top" } do |form| %>

        <!-- Search by User -->
        <div class="form-group">
          <%= form.label :user_search, "Recherche utilisateur", class: "block text-sm font-medium text-gray-300 mb-2" %>
          <%= form.text_field :user_search,
              value: params[:user_search],
              placeholder: "Nom, email...",
              class: "form-input" %>
        </div>

        <!-- Filter by Status -->
        <div class="form-group">
          <%= form.label :status, "Statut", class: "block text-sm font-medium text-gray-300 mb-2" %>
          <%= form.select :status,
              options_for_select([
                ['Tous les statuts', ''],
                ['En attente', 'pending'],
                ['Confirmé', 'confirmed'],
                ['Annulé', 'cancelled'],
                ['Présent', 'attended']
              ], params[:status]),
              {},
              { class: "form-input" } %>
        </div>

        <!-- Filter by Event -->
        <div class="form-group">
          <%= form.label :event_id, "Événement", class: "block text-sm font-medium text-gray-300 mb-2" %>
          <%= form.select :event_id,
              options_for_select([
                ['Tous les événements', '']
              ] + (@filter_options&.dig(:events) || Event.joins(:participations).distinct.limit(20).pluck(:title, :id)), params[:event_id]),
              {},
              { class: "form-input" } %>
        </div>

        <!-- Date Filter -->
        <div class="form-group">
          <%= form.label :date_filter, "Période", class: "block text-sm font-medium text-gray-300 mb-2" %>
          <%= form.select :date_filter,
              options_for_select([
                ['Toutes les périodes', ''],
                ['Aujourd\'hui', 'today'],
                ['Cette semaine', 'week'],
                ['Ce mois', 'month']
              ], params[:date_filter]),
              {},
              { class: "form-input" } %>
        </div>

        <!-- Payment Filter -->
        <div class="form-group">
          <%= form.label :payment_filter, "Paiement", class: "block text-sm font-medium text-gray-300 mb-2" %>
          <%= form.select :payment_filter,
              options_for_select([
                ['Tous', ''],
                ['Avec paiement', 'with_payment'],
                ['Sans paiement', 'without_payment']
              ], params[:payment_filter]),
              {},
              { class: "form-input" } %>
        </div>

        <!-- Filter by Venue -->
        <div class="form-group">
          <%= form.label :venue, "Lieu", class: "block text-sm font-medium text-gray-300 mb-2" %>
          <%= form.select :venue,
              options_for_select([
                ['Tous les lieux', '']
              ] + (@filter_options&.dig(:venues) || Event.joins(:participations).distinct.pluck(:venue_name).compact.uniq.map { |v| [v, v] }), params[:venue]),
              {},
              { class: "form-input" } %>
        </div>

        <!-- Sort Options -->
        <div class="form-group">
          <%= form.label :sort, "Trier par", class: "block text-sm font-medium text-gray-300 mb-2" %>
          <%= form.select :sort,
              options_for_select([
                ['Plus récent', 'created_at_desc'],
                ['Plus ancien', 'created_at_asc'],
                ['Par événement', 'event_date_desc'],
                ['Par utilisateur', 'user_name_asc'],
                ['Par montant', 'amount_desc']
              ], params[:sort]),
              {},
              { class: "form-input" } %>
        </div>

        <!-- Submit Button -->
        <div class="form-group flex items-end">
          <%= form.submit "Appliquer les filtres",
              class: "w-full btn-primary" %>
        </div>
      <% end %>

      <!-- Active Filters Display -->
      <% if params.slice(:user_search, :status, :event_id, :date_filter, :payment_filter, :venue).values.any?(&:present?) %>
        <div class="mt-6 pt-4 border-t border-white/10">
          <div class="flex items-center flex-wrap gap-2">
            <span class="text-sm text-gray-400 mr-2">Filtres actifs :</span>

            <% if params[:user_search].present? %>
              <span class="px-3 py-1 bg-primary/20 text-primary rounded-full text-xs">
                Utilisateur: "<%= params[:user_search] %>"
              </span>
            <% end %>

            <% if params[:status].present? %>
              <span class="px-3 py-1 bg-blue-500/20 text-blue-400 rounded-full text-xs">
                Statut: <%= params[:status].humanize %>
              </span>
            <% end %>

            <% if params[:event_id].present? %>
              <% event = Event.find_by(id: params[:event_id]) %>
              <% if event %>
                <span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-xs">
                  Événement: <%= event.title %>
                </span>
              <% end %>
            <% end %>

            <% if params[:date_filter].present? %>
              <span class="px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full text-xs">
                Période: <%= params[:date_filter].humanize %>
              </span>
            <% end %>

            <% if params[:payment_filter].present? %>
              <span class="px-3 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-xs">
                Paiement: <%= params[:payment_filter] == 'with_payment' ? 'Avec paiement' : 'Sans paiement' %>
              </span>
            <% end %>

            <% if params[:venue].present? %>
              <span class="px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-xs">
                Lieu: <%= params[:venue] %>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</section>
